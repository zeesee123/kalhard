



<%-include('templates/header')%>






<div class="d-flex justify-content-between mt-4">
    <h1><i class="bi bi-plus-circle mx-2"></i>Add blog</h1>
    <a href="/admin/view_blogs" target="_blank"><button class="btn btn-primary"><i class="bi bi-card-list mx-2"></i>View blogs</button></a>
    
</div>


<!-- <% if (success && success.length > 0) { %>
  <div class="alert alert-important alert-success alert-dismissible">
    <div class="d-flex"><i class="bi bi-check-circle-fill mx-1"></i><%= success[0] %></div>
    <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
    
  </div>
<% } %>

<% if (error && error.length > 0) { %>
  <div class="alert alert-danger alert-important alert-dismissible">
    <div class="d-flex"><i class="bi bi-exclamation-triangle-fill mx-1"></i><%= error[0] %></div>
    <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
  </div>
<% } %> -->

<form action="/admin/blog/create" enctype="multipart/form-data" method="POST"  id="main_form">

    <div class="card pt-3 p-4">

      <div class="row">

        <div class="row">
  <div class="mb-3 col-6">
      <label for="" class="form-label">Featured image</label>
      <input type="file" class="form-control img_inpp" name="blog_image">
      
  </div>
  <div class="mb-3 col-2 pt-4">
      
      <button type="button" class="btn btn-danger clear-btn" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="reset image"><i class="bi bi-arrow-clockwise"></i></button>
  </div>
  <div class="mb-3 col-4">
      <!-- <img class="Thumbnail" src="{{ optional($section)->sec2image ? asset_env('aboutpage/'.$section->sec2image) : asset_env('images/default.jpg') }}"  width="400" alt="Default picture Thumbnail"> -->
      <img class="Thumbnail" src="/admin/assets/dist/defaultimages/default.jpg"  width="400" alt="Default picture Thumbnail">
      
  </div>
</div>

        <div class="mb-3 col-6">
          <label for="" class="form-label">blog title</label>
          <input type="text" class="form-control" name="title">
        </div>

        <div class="mb-3 col-6">
  <label for="blog_category" class="form-label">Blog Category</label>
  <select name="category" id="blog_category" class="form-control">
    <% categories.forEach(cat => { %>
      <option value="<%= cat._id %>"><%= ucfirst(cat.name) %></option>
    <% }); %>
  </select>
</div>

<div class="mb-3 col-6">
  <label for="blog_author" class="form-label">Author Name</label>
  <select name="author" id="blog_author" class="form-control">
    <% authors.forEach(auth => { %>
      <option value="<%= auth._id %>"><%= ucfirst(auth.name) %></option>
    <% }); %>
  </select>
</div>


<div class="mb-3 col-6">
  <label for="blog_author" class="form-label">Tags</label>
  <select name="tag" id="blog_author" class="form-control" multiple>
    <% tags.forEach(tag => { %>
      <option value="<%= tag._id %>"><%= ucfirst(tag.name) %></option>
    <% }); %>
  </select>
</div>

<div class="mb-3 col-6">
  <label for="blog_author" class="form-label">Topics</label>
  <select name="topics" id="blog_author" class="form-control" multiple>
    <% topics.forEach(tag => { %>
      <option value="<%= tag._id %>"><%= ucfirst(tag.name) %></option>
    <% }); %>
  </select>
</div>

<div class="mb-3 col-6">
  <label for="blog_author" class="form-label">Industries</label>
  <select name="industries" id="blog_author" class="form-control" multiple>
    <% industries.forEach(tag => { %>
      <option value="<%= tag._id %>"><%= ucfirst(tag.name) %></option>
    <% }); %>
  </select>
</div>

        <div class="mb-3 col-6">
          <label for="" class="form-label">Date</label>
          <input type="date" class="form-control">
          
          
        </div>

        <div class="mb-3 col-6 mt-5">
          <div class="form-check form-switch">
  <input class="form-check-input" name="publish" type="checkbox" role="switch" id="switchCheckDefault">
  <label class="form-check-label" for="switchCheckDefault">Publish</label>
</div>
        </div>
        

        <div class="mb-3 col-12">
          <label for="" class="form-label">blog content</label>
          <textarea name="content" id="blog_content" class="form-control"></textarea>
          
        </div>
        
      </div>

    </div>


    <div class="accordion" id="accordionExample">

      <div class="accordion-item mb-3 mt-3">
  <h2 class="accordion-header">
    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSEO" aria-expanded="false" aria-controls="collapseCaseStudies">
      <i class="bi bi-globe mx-2"></i>SEO
    </button>
  </h2>
  <div id="collapseSEO" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
    <div class="accordion-body">
      <div class="card pt-3 p-4">

        <h3>SEO
        </h3>
        

        <div class="mb-3">
          <label for="" class="form-label">SEO Title (Meta Title)</label>
          <input type="text" name="meta_title" class="form-control">
        </div>

        <div class="mb-3">
          <label for="" class="form-label">Slug (URL)</label>
          <input type="text" name="slug" class="form-control">
        </div>

        <div class="mb-3">
          <label for="" class="form-label">Meta Description</label>
          <textarea name="meta_description" rows="3" class="form-control"></textarea>
        </div>


        <div class="mb-3">
          <label for="" class="form-label">Structured Data (Schema Markup)</label>
          <textarea name="schema_markup" rows="5" class="form-control" placeholder='Paste JSON-LD here'></textarea>
        </div>


    
        

        
    </div>
    </div>
  </div>
</div>

    </div>
    

<div class="text-end p-3" style="bottom:0;position:sticky;z-index: 1030;">
    <button class="btn btn-lg btn-primary p-3" id="spin_submit" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Save"><i class="bi bi-floppy2-fill mx-2" ></i></button> 
     
</div>

</form>


<!-- datable -->

<script src="/admin/assets/tinymce/tinymce.min.js" referrerpolicy="origin"></script>



<script src="
https://cdn.jsdelivr.net/npm/filepond@4.32.7/dist/filepond.min.js
"></script>


<script src="
https://cdn.jsdelivr.net/npm/filepond-plugin-image-preview@4.6.12/dist/filepond-plugin-image-preview.min.js
"></script>

<script>
    //script for photo clear button

let clearBtns=document.querySelectorAll('.clear-btn');

clearBtns.forEach((v,i)=>{
  v.addEventListener('click',function(){

    const img = document.querySelectorAll('.Thumbnail')[i];

  
    img.src=`/admin/assets/dist/defaultimages/default.jpg`;
    
console.log(document.querySelectorAll('.img_inpp'));
    document.querySelectorAll('.img_inpp')[i].value='';

  });
})


//script for the image inputs preview

// Loop through each file input

let imageInputs=document.querySelectorAll('.img_inpp');
let thumb=document.querySelectorAll('.Thumbnail');

imageInputs.forEach((input, index) => {
  console.log('this isthe index first',index);
    input.addEventListener('change', function(event) {
      console.log('this the index real',index);
        const file = event.target.files[0]; // Get the selected file

        if (file) {
            const reader = new FileReader(); // Create a FileReader object

            reader.onload = function(e) {
                // Get the corresponding image preview element
                const img = thumb[index];
                console.log('this is the index',index,img);
                img.src = e.target.result; // Set the image source to the file's data URL
                img.style.display = 'block'; // Show the image
            }

            reader.readAsDataURL(file); // Read the file as a data URL
        }
    });

   
});


//dynamic inputs thumbnail
</script>
<script>

    

tinymce.init({
  selector: '#blog_content',
  plugins: 'link image code lists',
  toolbar: 'undo redo | bold italic | link image | insertMedia',
  relative_urls: false,          // ← force absolute URLs
  remove_script_host: false,     // ← include full host
  document_base_url: window.location.origin + '/admin/assets/dist/',  // base URL for relative paths
  setup: function(editor) {
    editor.ui.registry.addButton('insertMedia', {
      text: 'Insert Media',
      onAction: function() {

        const basePath = window.location.origin + '/admin/assets/dist';

        // Fetch media list
        fetch('/admin/media/list')
          .then(res => res.json())
          .then(files => {

            const validFiles = files.filter(f => f.url);

            // Prepare HTML for tabs
            const tabs = `
              <div style="display:flex;gap:5px;margin-bottom:10px;">
                <button class="tab-btn active" data-tab="images">Images</button>
                <button class="tab-btn" data-tab="docs">Docs</button>
                <button class="tab-btn" data-tab="videos">Videos</button>
                <button class="tab-btn" data-tab="others">Others</button>
                <button class="tab-btn" data-tab="upload">Upload</button>
              </div>
              <div class="tab-content" style="max-height:300px;overflow-y:auto;">
                <div class="tab-panel" data-panel="images" style="display:flex;flex-wrap:wrap;">
                  ${validFiles.filter(f => f.type === 'image').map(f => {
                    const url = basePath + f.url;
                    return `<img src="${url}" data-url="${url}" class="swal-media-thumb" 
                             style="width:100px;height:100px;object-fit:cover;margin:5px;cursor:pointer;">`;
                  }).join('')}
                </div>
                <div class="tab-panel" data-panel="docs" style="display:none;flex-wrap:wrap;">
                  ${validFiles.filter(f => f.type === 'doc' || f.type==='pdf').map(f => {
                    const url = basePath + f.url;
                    const name = f.url.split('/').pop();
                    return `<a href="#" data-url="${url}" class="swal-media-thumb" style="display:block;margin:5px;cursor:pointer;">${name}</a>`;
                  }).join('')}
                </div>
                <div class="tab-panel" data-panel="videos" style="display:none;flex-wrap:wrap;">
                  ${validFiles.filter(f => f.type === 'video').map(f => {
                    const url = basePath + f.url;
                    return `<video src="${url}" width="150" style="margin:5px;cursor:pointer;" controls></video>`;
                  }).join('')}
                </div>
                <div class="tab-panel" data-panel="others" style="display:none;flex-wrap:wrap;">
                  ${validFiles.filter(f => !['image','doc','pdf','video'].includes(f.type)).map(f => {
                    const url = basePath + f.url;
                    const name = f.url.split('/').pop();
                    return `<a href="#" data-url="${url}" class="swal-media-thumb" style="display:block;margin:5px;cursor:pointer;">${name}</a>`;
                  }).join('')}
                </div>
                <div class="tab-panel" data-panel="upload" style="display:none;">
                  <input type="file" id="swal-upload-input" style="width:100%;">
                  <small>Choose a file and it will be uploaded & inserted</small>
                </div>
              </div>
            `;

            Swal.fire({
              title: 'Media Manager',
              html: tabs,
              width: 800,
              showCloseButton: true,
              showCancelButton: true,
              didOpen: () => {

                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                  btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                    document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='none');
                    btn.classList.add('active');
                    document.querySelector(`.tab-panel[data-panel="${btn.dataset.tab}"]`).style.display = btn.dataset.tab==='upload'?'block':'flex';
                  });
                });

                // Insert media click
                document.querySelectorAll('.tab-panel .swal-media-thumb').forEach(el => {
                  el.addEventListener('click', () => {
                    const url = el.dataset.url;
                    if (url.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
                      editor.insertContent(`<img src="${url}" />`);
                    } else {
                      const name = url.split('/').pop();
                      editor.insertContent(`<a href="${url}" target="_blank">${name}</a>`);
                    }
                    Swal.close();
                  });
                });

                // Upload logic
                const uploadInput = document.getElementById('swal-upload-input');
                uploadInput?.addEventListener('change', () => {
                  const file = uploadInput.files[0];
                  const formData = new FormData();
                  formData.append('file', file);

                  fetch('/admin/media/upload', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                      if(data.url){
                        //const url = basePath + data.url;
                        const url = new URL(data.url, window.location.origin + '/admin/assets/dist/').href;
                        if(file.type.startsWith('image/')){
                          editor.insertContent(`<img src="${url}" />`);
                        } else {
                          editor.insertContent(`<a href="${url}" target="_blank">${file.name}</a>`);
                        }
                        Swal.close();
                      } else {
                        Swal.fire('Error','Upload failed','error');
                      }
                    }).catch(()=>Swal.fire('Error','Upload failed','error'));
                });

              }
            });

          })
          .catch(err => {
            console.error(err);
            Swal.fire('Error','Could not fetch media','error');
          });

      }
    });
  }
});

    </script>



<script>
    let main_form=document.getElementById('main_form');

    let spin_submit=document.getElementById('spin_submit');

    main_form.addEventListener('submit',(e)=>{

        e.preventDefault();

        spin_submit.innerHTML=`<div class="spinner-border mx-2" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>`;
        
        console.log('submit event');

        main_form.submit();
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  <% if (success && success.length > 0) { %>
    Swal.fire({
      icon: 'success',
      title: 'Saved!',
      text: '<%= success[0] %>',
      confirmButtonColor: '#3085d6',
    });
  <% } %>

  <% if (error && error.length > 0) { %>
    Swal.fire({
      icon: 'error',
      title: 'Error!',
      text: '<%= error[0] %>',
      confirmButtonColor: '#d33',
    });
  <% } %>
</script>




<%-include('templates/footer')%>